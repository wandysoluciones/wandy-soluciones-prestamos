{% extends "base.html" %}

{% block title %}Clientes Atrasados - Wandy Soluciones{% endblock %}
{% block page_title %}Clientes Atrasados{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">Control de Clientes Atrasados</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Clientes Atrasados</li>
                </ol>
            </nav>
        </div>
        <div>
            <button class="btn btn-warning me-2" onclick="enviarNotificacionesMasivas()">
                <i class="fas fa-bell me-2"></i>Enviar Notificaciones
            </button>
            <button class="btn btn-danger" onclick="generarReporteAtrasos()">
                <i class="fas fa-file-pdf me-2"></i>Reporte PDF
            </button>
        </div>
    </div>
</div>

<!-- Filtros y estadísticas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ cuotas_atrasadas|length }}</h4>
                        <p class="mb-0">Cuotas Atrasadas</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ clientes_atrasados|length }}</h4>
                        <p class="mb-0">Clientes Atrasados</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">RD$ {{ "%.2f"|format(monto_total_atrasado) }}</h4>
                        <p class="mb-0">Monto Total Atrasado</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-dollar-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ dias_promedio_atraso|round(1) }}</h4>
                        <p class="mb-0">Días Promedio Atraso</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="filterNombre" placeholder="Buscar por nombre...">
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="filterProvincia">
            <option value="">Todas las provincias</option>
            <option value="Santo Domingo">Santo Domingo</option>
            <option value="Santiago">Santiago</option>
            <option value="La Vega">La Vega</option>
            <option value="San Cristóbal">San Cristóbal</option>
            <option value="San Pedro de Macorís">San Pedro de Macorís</option>
            <option value="La Romana">La Romana</option>
            <option value="Puerto Plata">Puerto Plata</option>
            <option value="Barahona">Barahona</option>
            <option value="Azua">Azua</option>
            <option value="San Juan">San Juan</option>
            <option value="Duarte">Duarte</option>
            <option value="Peravia">Peravia</option>
            <option value="Valverde">Valverde</option>
            <option value="Monte Plata">Monte Plata</option>
            <option value="Hato Mayor">Hato Mayor</option>
            <option value="Monte Cristi">Monte Cristi</option>
            <option value="El Seibo">El Seibo</option>
            <option value="Baoruco">Baoruco</option>
            <option value="Independencia">Independencia</option>
            <option value="Pedernales">Pedernales</option>
            <option value="Elías Piña">Elías Piña</option>
            <option value="Dajabón">Dajabón</option>
            <option value="Samaná">Samaná</option>
            <option value="María Trinidad Sánchez">María Trinidad Sánchez</option>
            <option value="Monseñor Nouel">Monseñor Nouel</option>
            <option value="Espaillat">Espaillat</option>
            <option value="Hermanas Mirabal">Hermanas Mirabal</option>
            <option value="Sánchez Ramírez">Sánchez Ramírez</option>
            <option value="Cotui">Cotui</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="filterAtraso">
            <option value="">Todos los atrasos</option>
            <option value="1-30">1-30 días</option>
            <option value="31-60">31-60 días</option>
            <option value="61-90">61-90 días</option>
            <option value="90+">Más de 90 días</option>
        </select>
    </div>
    <div class="col-md-2">
        <button class="btn btn-outline-primary w-100" onclick="actualizarAtrasos()">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>
</div>

<!-- Tabla de clientes atrasados -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-list me-2"></i>Lista de Clientes Atrasados
        </h5>
    </div>
    <div class="card-body">
        {% if cuotas_atrasadas and cuotas_atrasadas|length > 0 %}
        <div class="table-responsive">
            <table class="table table-hover" id="tablaAtrasados">
                <thead class="table-dark">
                    <tr>
                        <th>Cliente</th>
                        <th>Préstamo</th>
                        <th>Cuota</th>
                        <th>Monto Atrasado</th>
                        <th>Fecha Vencimiento</th>
                        <th>Días Atraso</th>
                        <th>Rango Atraso</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cuota in cuotas_atrasadas %}
                    {% if cuota.prestamo and cuota.prestamo.cliente %}
                    {% set dias_atraso = ((today - cuota.fecha_vencimiento).days) if cuota.fecha_vencimiento < today else 0 %}
                    <tr class="{% if dias_atraso > 90 %}table-danger{% elif dias_atraso > 60 %}table-warning{% else %}table-light{% endif %}">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm me-3">
                                    <i class="fas fa-user-circle fa-2x text-primary"></i>
                                </div>
                                <div>
                                    <strong>{{ cuota.prestamo.cliente.nombre or 'N/A' }} {{ cuota.prestamo.cliente.apellidos or '' }}</strong>
                                    <br><small class="text-muted">{{ cuota.prestamo.cliente.documento or 'N/A' }}</small>
                                    <br><small class="text-muted">{{ cuota.prestamo.cliente.telefono_principal or 'N/A' }}</small>
                                    {% if cuota.prestamo.cliente.correo %}
                                    <br><small class="text-info">{{ cuota.prestamo.cliente.correo }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            <strong>RD$ {{ "%.2f"|format(cuota.prestamo.monto or 0) }}</strong>
                            <br><small class="text-muted">#{{ cuota.prestamo.id or 'N/A' }}</small>
                        </td>
                        <td>
                            <span class="badge bg-info">Cuota #{{ cuota.numero_cuota or 'N/A' }}</span>
                            <br><small class="text-muted">RD$ {{ "%.2f"|format(cuota.monto_total or 0) }}</small>
                        </td>
                        <td>
                            <strong class="text-danger">RD$ {{ "%.2f"|format(cuota.monto_total or 0) }}</strong>
                        </td>
                        <td>
                            {{ cuota.fecha_vencimiento.strftime('%d/%m/%Y') if cuota.fecha_vencimiento else 'N/A' }}
                        </td>
                        <td>
                            <span class="badge {% if dias_atraso > 90 %}bg-danger{% elif dias_atraso > 60 %}bg-warning{% else %}bg-info{% endif %}">
                                {{ dias_atraso }} días
                            </span>
                        </td>
                        <td>
                            {% if dias_atraso <= 30 %}
                                <span class="badge bg-info">1-30 días</span>
                            {% elif dias_atraso <= 60 %}
                                <span class="badge bg-warning">31-60 días</span>
                            {% elif dias_atraso <= 90 %}
                                <span class="badge bg-orange">61-90 días</span>
                            {% else %}
                                <span class="badge bg-danger">90+ días</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        onclick="verCliente({{ cuota.prestamo.cliente.id or 0 }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success" 
                                        onclick="registrarPago({{ cuota.id or 0 }})">
                                    <i class="fas fa-money-bill-wave"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-warning" 
                                        onclick="contactarCliente({{ cuota.prestamo.cliente.id or 0 }})">
                                    <i class="fas fa-phone"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        onclick="enviarRecordatorio({{ cuota.id or 0 }}, '{{ cuota.prestamo.cliente.correo or '' }}', '{{ cuota.prestamo.cliente.nombre or 'Cliente' }} {{ cuota.prestamo.cliente.apellidos or '' }}')">
                                    <i class="fas fa-bell"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <h5 class="text-success">¡Excelente! No hay cuotas atrasadas</h5>
            <p class="text-muted">Todos los clientes están al día con sus pagos</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para registrar pago -->
<div class="modal fade" id="pagoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar Pago</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="pagoModalBody">
                <!-- Contenido del modal se carga dinámicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarPago()">Registrar Pago</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para confirmar envío de notificaciones -->
<div class="modal fade" id="notificacionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Envío de Notificaciones</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea enviar notificaciones por email a todos los clientes atrasados?</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Se enviarán recordatorios personalizados a todos los clientes que tengan cuotas atrasadas.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="confirmarEnvioNotificaciones()">
                    <i class="fas fa-paper-plane me-2"></i>Enviar Notificaciones
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast para notificaciones -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-bell me-2"></i>
            <strong class="me-auto">Notificación</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            <!-- Mensaje del toast -->
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Brevo Email Service -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
// Configuración de Brevo (reemplazando EmailJS)
// Las funciones de envío ahora usan la API de Flask que se comunica con Brevo

// Variables globales
let cuotasAtrasadasData = [];
let isLoading = false;

// Función para mostrar toast
function showToast(message, type = 'info') {
    const toast = document.getElementById('notificationToast');
    const toastMessage = document.getElementById('toastMessage');
    
    toastMessage.textContent = message;
    toast.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');
    toast.classList.add(`bg-${type}`);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// Función para mostrar/ocultar loading
function showLoading(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Procesando...</p>
            </div>
        `;
    }
    isLoading = true;
}

function hideLoading(elementId) {
    isLoading = false;
}

// Función para sanitizar HTML
function sanitizeHTML(input) {
    if (typeof input !== 'string') return '';
    return input.replace(/[<>&"']/g, '');
}

// Función para enviar recordatorio individual
async function enviarRecordatorio(cuotaId, email, nombreCliente) {
    if (!email || email.trim() === '') {
        showToast('Este cliente no tiene correo electrónico registrado.', 'warning');
        return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showToast('Dirección de correo electrónico inválida.', 'error');
        return;
    }

    try {
        // Obtener datos de la cuota
        const response = await fetch(`/api/cuota/${cuotaId}`);
        if (!response.ok) throw new Error('Error al obtener datos de la cuota');
        
        const cuotaData = await response.json();
        console.log('Datos recibidos de la API:', cuotaData);
        
        // Los datos están anidados en cuotaData.cuota
        const cuota = cuotaData.cuota;
        
        // Preparar parámetros del email con validaciones
        const prestamoMonto = parseFloat(cuota.prestamo_monto) || 0;
        const montoTotal = parseFloat(cuota.monto_total) || 0;
        const numeroCuota = cuota.numero_cuota || 'N/A';
        const fechaVencimiento = cuota.fecha_vencimiento || 'N/A';
        
        const emailParams = {
            to_email: email.trim(),
            client_name: sanitizeHTML(nombreCliente || 'Cliente'),
            loan_amount: prestamoMonto.toFixed(2),
            overdue_amount: montoTotal.toFixed(2),
            due_date: fechaVencimiento,
            cuota_number: numeroCuota,
            subject: `Recordatorio de Pago Atrasado - ${sanitizeHTML(nombreCliente || 'Cliente')}`,
            message: `Estimado/a ${sanitizeHTML(nombreCliente)},\n\nLe recordamos que tiene una cuota atrasada #${numeroCuota} por RD$${montoTotal.toFixed(2)} correspondiente a su préstamo de RD$${prestamoMonto.toFixed(2)}. Por favor, regularice su pago lo antes posible.\n\nGracias,\nWandy Soluciones y Préstamos`
        };

        // Enviar email usando Brevo a través de la API de Flask
        console.log('Enviando email con parámetros:', emailParams);
        
        const brevoData = {
            cliente_email: email.trim(),
            cliente_nombre: sanitizeHTML(nombreCliente || 'Cliente'),
            datos_cuota: {
                prestamo_id: cuota.prestamo_id || 'N/A',
                cuota_numero: numeroCuota,
                fecha_vencimiento: fechaVencimiento,
                dias_atraso: Math.max(0, Math.ceil((new Date() - new Date(fechaVencimiento)) / (1000 * 60 * 60 * 24))),
                monto_original: montoTotal.toFixed(2),
                interes_atraso: (montoTotal * 0.05).toFixed(2), // 5% de interés por atraso
                monto_total: (montoTotal * 1.05).toFixed(2)
            }
        };
        
        const result = await axios.post('/api/enviar-notificacion-brevo', brevoData);
        console.log('Email enviado exitosamente:', result.data);
        showToast('Recordatorio enviado exitosamente al cliente.', 'success');
        
    } catch (error) {
        console.error('Error al enviar el recordatorio:', error);
        showToast(`No se pudo enviar el recordatorio: ${error.message || 'Error desconocido.'}`, 'error');
    }
}

// Función para enviar notificaciones masivas
function enviarNotificacionesMasivas() {
    const modal = new bootstrap.Modal(document.getElementById('notificacionModal'));
    modal.show();
}

// Función para confirmar envío de notificaciones masivas
async function confirmarEnvioNotificaciones() {
    if (isLoading) return;
    
    try {
        showLoading('pagoModalBody');
        
        // Obtener todas las cuotas atrasadas
        const response = await fetch('/api/cuotas-atrasadas');
        if (!response.ok) throw new Error('Error al obtener cuotas atrasadas');
        
        const cuotasData = await response.json();
        const cuotasConEmail = cuotasData.filter(cuota => 
            cuota.cliente_correo && cuota.cliente_correo.trim() !== ''
        );
        
        if (cuotasConEmail.length === 0) {
            showToast('No hay clientes con correo electrónico registrado para enviar notificaciones.', 'warning');
            return;
        }
        
        // Enviar notificaciones
        let enviados = 0;
        let errores = 0;
        
        for (const cuota of cuotasConEmail) {
            try {
                // Validar y convertir valores numéricos
                const prestamoMonto = parseFloat(cuota.prestamo_monto) || 0;
                const montoTotal = parseFloat(cuota.monto_total) || 0;
                const numeroCuota = cuota.numero_cuota || 'N/A';
                const fechaVencimiento = cuota.fecha_vencimiento || 'N/A';
                
                const emailParams = {
                    to_email: cuota.cliente_correo.trim(),
                    client_name: sanitizeHTML(cuota.cliente_nombre || 'Cliente'),
                    loan_amount: prestamoMonto.toFixed(2),
                    overdue_amount: montoTotal.toFixed(2),
                    due_date: fechaVencimiento,
                    cuota_number: numeroCuota,
                    subject: `Recordatorio de Pago Atrasado - ${sanitizeHTML(cuota.cliente_nombre || 'Cliente')}`,
                    message: `Estimado/a ${sanitizeHTML(cuota.cliente_nombre)},\n\nLe recordamos que tiene una cuota atrasada #${numeroCuota} por RD$${montoTotal.toFixed(2)} correspondiente a su préstamo de RD$${prestamoMonto.toFixed(2)}. Por favor, regularice su pago lo antes posible.\n\nGracias,\nWandy Soluciones y Préstamos`
                };
                
                console.log('Enviando email masivo a:', cuota.cliente_correo, 'con parámetros:', emailParams);
                
                // Preparar datos para Brevo
                const brevoData = {
                    cliente_email: cuota.cliente_correo.trim(),
                    cliente_nombre: sanitizeHTML(cuota.cliente_nombre || 'Cliente'),
                    datos_cuota: {
                        prestamo_id: cuota.prestamo_id || 'N/A',
                        cuota_numero: numeroCuota,
                        fecha_vencimiento: fechaVencimiento,
                        dias_atraso: Math.max(0, Math.ceil((new Date() - new Date(fechaVencimiento)) / (1000 * 60 * 60 * 24))),
                        monto_original: montoTotal.toFixed(2),
                        interes_atraso: (montoTotal * 0.05).toFixed(2), // 5% de interés por atraso
                        monto_total: (montoTotal * 1.05).toFixed(2)
                    }
                };
                
                const result = await axios.post('/api/enviar-notificacion-brevo', brevoData);
                console.log('Email masivo enviado exitosamente:', result.data);
                enviados++;
                
                // Pequeña pausa para evitar sobrecarga
                await new Promise(resolve => setTimeout(resolve, 500));
                
            } catch (error) {
                console.error(`Error al enviar a ${cuota.cliente_correo}:`, error);
                errores++;
            }
        }
        
        // Mostrar resultado
        if (errores === 0) {
            showToast(`Se enviaron ${enviados} notificaciones exitosamente.`, 'success');
        } else {
            showToast(`Se enviaron ${enviados} notificaciones. ${errores} fallaron.`, 'warning');
        }
        
        // Cerrar modal y recargar página
        bootstrap.Modal.getInstance(document.getElementById('notificacionModal')).hide();
        setTimeout(() => location.reload(), 2000);
        
    } catch (error) {
        console.error('Error al enviar notificaciones masivas:', error);
        showToast(`Error al enviar notificaciones: ${error.message || 'Error desconocido.'}`, 'error');
    } finally {
        hideLoading('pagoModalBody');
    }
}

// Filtro por nombre
document.getElementById('filterNombre').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const clienteCell = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
        row.style.display = clienteCell.includes(searchTerm) ? '' : 'none';
    });
});

// Filtro por provincia
document.getElementById('filterProvincia').addEventListener('change', function() {
    const provincia = this.value;
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const clienteCell = row.querySelector('td:nth-child(1)').textContent;
        row.style.display = !provincia || clienteCell.includes(provincia) ? '' : 'none';
    });
});

// Filtro por días de atraso
document.getElementById('filterAtraso').addEventListener('change', function() {
    const rango = this.value;
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const diasCell = row.querySelector('td:nth-child(6) .badge').textContent;
        const dias = parseInt(diasCell.match(/\d+/)[0]);
        
        let mostrar = true;
        if (rango === '1-30') mostrar = dias <= 30;
        else if (rango === '31-60') mostrar = dias > 30 && dias <= 60;
        else if (rango === '61-90') mostrar = dias > 60 && dias <= 90;
        else if (rango === '90+') mostrar = dias > 90;
        
        row.style.display = mostrar ? '' : 'none';
    });
});

// Función para ver cliente
function verCliente(clienteId) {
    window.location.href = `/clientes/${clienteId}`;
}

// Función para registrar pago
function registrarPago(cuotaId) {
    const modal = new bootstrap.Modal(document.getElementById('pagoModal'));
    document.getElementById('pagoModalBody').innerHTML = `
        <div class="text-center">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>Cargando formulario de pago...</p>
        </div>
    `;
    modal.show();
    
    // Aquí se cargaría el formulario de pago via AJAX
    setTimeout(() => {
        document.getElementById('pagoModalBody').innerHTML = `
            <form id="formPago">
                <div class="mb-3">
                    <label class="form-label">Monto a Pagar</label>
                    <input type="number" class="form-control" id="montoPago" step="0.01" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Tipo de Pago</label>
                    <select class="form-select" id="tipoPago">
                        <option value="Normal">Normal</option>
                        <option value="Parcial">Parcial</option>
                        <option value="Adelantado">Adelantado</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Observaciones</label>
                    <textarea class="form-control" id="observaciones" rows="3"></textarea>
                </div>
            </form>
        `;
    }, 1000);
}

// Función para contactar cliente
function contactarCliente(clienteId) {
    // Aquí se implementaría la funcionalidad de contacto
    showToast('Función de contacto en desarrollo', 'info');
}

// Función para generar reporte de atrasos
function generarReporteAtrasos() {
    window.open('/atrasados/reporte', '_blank');
}

// Función para actualizar atrasos
function actualizarAtrasos() {
    location.reload();
}

// Función para confirmar pago
function confirmarPago() {
    const monto = document.getElementById('montoPago').value;
    const tipo = document.getElementById('tipoPago').value;
    
    if (monto && tipo) {
        showToast('Pago registrado exitosamente', 'success');
        bootstrap.Modal.getInstance(document.getElementById('pagoModal')).hide();
        setTimeout(() => location.reload(), 1500);
    } else {
        showToast('Por favor complete todos los campos', 'warning');
    }
}

// Inicialización cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    // Verificar si Brevo está configurado (a través de la API de Flask)
    // Brevo se verifica automáticamente al hacer la primera llamada a la API
});
</script>
{% endblock %}
