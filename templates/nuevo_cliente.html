{% extends "base.html" %}

{% block title %}Nuevo Cliente - Wandy Soluciones{% endblock %}
{% block page_title %}Nuevo Cliente{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">Registrar Nuevo Cliente</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('clientes') }}">Clientes</a></li>
                    <li class="breadcrumb-item active">Nuevo Cliente</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="{{ url_for('clientes') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver
            </a>
        </div>
    </div>
</div>

<form method="POST" class="needs-validation" novalidate>
    <div class="row">
        <!-- Datos Personales -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user me-2"></i>Datos Personales
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nombre" class="form-label">Nombres *</label>
                            <input type="text" class="form-control" id="nombre" name="nombre" required>
                            <div class="invalid-feedback">
                                Por favor ingrese los nombres.
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="apellidos" class="form-label">Apellidos *</label>
                            <input type="text" class="form-control" id="apellidos" name="apellidos" required>
                            <div class="invalid-feedback">
                                Por favor ingrese los apellidos.
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="apodo" class="form-label">Apodo</label>
                            <input type="text" class="form-control" id="apodo" name="apodo">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="documento" class="form-label">Documento de Identidad *</label>
                            <input type="text" class="form-control" id="documento" name="documento" required>
                            <div class="invalid-feedback">
                                Por favor ingrese el documento de identidad.
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nacionalidad" class="form-label">Nacionalidad *</label>
                            <select class="form-select" id="nacionalidad" name="nacionalidad" required>
                                <option value="">Seleccionar</option>
                                <option value="Dominicano">Dominicano</option>
                                <option value="Otro">Otro</option>
                            </select>
                            <div class="invalid-feedback">
                                Por favor seleccione la nacionalidad.
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fecha_nacimiento" class="form-label">Fecha de Nacimiento</label>
                            <input type="date" class="form-control" id="fecha_nacimiento" name="fecha_nacimiento">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Sexo *</label>
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="sexo" id="sexoMasculino" value="Masculino" required>
                                    <label class="form-check-label" for="sexoMasculino">
                                        Masculino
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="sexo" id="sexoFemenino" value="Femenino">
                                    <label class="form-check-label" for="sexoFemenino">
                                        Femenino
                                    </label>
                                </div>
                            </div>
                            <div class="invalid-feedback">
                                Por favor seleccione el sexo.
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="estado_civil" class="form-label">Estado Civil *</label>
                            <input type="text" class="form-control" id="estado_civil" name="estado_civil" required>
                            <div class="invalid-feedback">
                                Por favor ingrese el estado civil.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Datos de Contacto -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-phone me-2"></i>Datos de Contacto
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="whatsapp" class="form-label">WhatsApp</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fab fa-whatsapp text-success"></i></span>
                            <input type="tel" class="form-control" id="whatsapp" name="whatsapp" placeholder="809-123-4567">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="telefono_principal" class="form-label">Teléfono Principal *</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-phone"></i></span>
                            <input type="tel" class="form-control" id="telefono_principal" name="telefono_principal" required>
                        </div>
                        <div class="invalid-feedback">
                            Por favor ingrese el teléfono principal.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="telefono_otro" class="form-label">Teléfono Otro</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-phone"></i></span>
                            <input type="tel" class="form-control" id="telefono_otro" name="telefono_otro">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="correo" class="form-label">Correo Electrónico *</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                            <input type="email" class="form-control" id="correo" name="correo" required>
                        </div>
                        <div class="invalid-feedback">
                            Por favor ingrese un correo electrónico válido.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Dirección -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>Dirección
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="direccion" class="form-label">Dirección *</label>
                        <textarea class="form-control" id="direccion" name="direccion" rows="3" required></textarea>
                        <div class="invalid-feedback">
                            Por favor ingrese la dirección.
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="provincia" class="form-label">Provincia *</label>
                            <select class="form-select" id="provincia" name="provincia" required>
                                <option value="">Seleccionar provincia</option>
                                {% for provincia in provincias %}
                                <option value="{{ provincia }}">{{ provincia }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">
                                Por favor seleccione la provincia.
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="municipio" class="form-label">Municipio *</label>
                            <select class="form-select" id="municipio" name="municipio" required>
                                <option value="">Seleccionar municipio</option>
                            </select>
                            <div class="invalid-feedback">
                                Por favor seleccione el municipio.
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="sector" class="form-label">Sector *</label>
                            <input type="text" class="form-control" id="sector" name="sector" required>
                            <div class="invalid-feedback">
                                Por favor ingrese el sector.
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="ruta" class="form-label">Ruta de Cobro/Entrega</label>
                            <select class="form-select" id="ruta" name="ruta">
                                <option value="">Ruta Principal</option>
                                <option value="Ruta 1">Ruta 1</option>
                                <option value="Ruta 2">Ruta 2</option>
                                <option value="Ruta 3">Ruta 3</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Datos Laborales -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-briefcase me-2"></i>Datos Laborales
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="ocupacion" class="form-label">Ocupación *</label>
                        <input type="text" class="form-control" id="ocupacion" name="ocupacion" required>
                        <div class="invalid-feedback">
                            Por favor ingrese la ocupación.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="ingresos" class="form-label">Ingresos Mensuales (RD$) *</label>
                        <div class="input-group">
                            <span class="input-group-text">RD$</span>
                            <input type="number" class="form-control" id="ingresos" name="ingresos" step="0.01" min="0" required>
                        </div>
                        <div class="invalid-feedback">
                            Por favor ingrese los ingresos mensuales.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="situacion_laboral" class="form-label">Situación Laboral *</label>
                        <select class="form-select" id="situacion_laboral" name="situacion_laboral" required>
                            <option value="">Seleccionar</option>
                            <option value="Empleado">Empleado</option>
                            <option value="Independiente">Independiente</option>
                            <option value="Empresario">Empresario</option>
                            <option value="Jubilado">Jubilado</option>
                            <option value="Estudiante">Estudiante</option>
                            <option value="Otro">Otro</option>
                        </select>
                        <div class="invalid-feedback">
                            Por favor seleccione la situación laboral.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="lugar_trabajo" class="form-label">Lugar de Trabajo *</label>
                        <input type="text" class="form-control" id="lugar_trabajo" name="lugar_trabajo" required>
                        <div class="invalid-feedback">
                            Por favor ingrese el lugar de trabajo.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="direccion_trabajo" class="form-label">Dirección de Trabajo *</label>
                        <textarea class="form-control" id="direccion_trabajo" name="direccion_trabajo" rows="2" required></textarea>
                        <div class="invalid-feedback">
                            Por favor ingrese la dirección de trabajo.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones de acción -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </button>
                        <div>
                            <button type="button" class="btn btn-outline-info me-2" onclick="guardarBorrador()">
                                <i class="fas fa-save me-2"></i>Guardar Borrador
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-check me-2"></i>Registrar Cliente
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// Validación del formulario
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// Función para guardar borrador
function guardarBorrador() {
    // Implementar guardado como borrador
    alert('Función de borrador en desarrollo');
}

// Cargar municipios según provincia seleccionada
document.getElementById('provincia').addEventListener('change', function() {
    const provincia = this.value;
    const municipioSelect = document.getElementById('municipio');
    
    // Limpiar opciones actuales
    municipioSelect.innerHTML = '<option value="">Seleccionar municipio</option>';
    
    if (provincia) {
        // Cargar municipios desde la API
        fetch(`/api/municipios/${encodeURIComponent(provincia)}`)
            .then(response => response.json())
            .then(municipios => {
                municipios.forEach(municipio => {
                    const option = document.createElement('option');
                    option.value = municipio;
                    option.textContent = municipio;
                    municipioSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error al cargar municipios:', error);
            });
    }
});

// Formatear números de teléfono
function formatPhoneNumber(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length >= 3) {
        value = value.substring(0, 3) + '-' + value.substring(3);
    }
    if (value.length >= 7) {
        value = value.substring(0, 7) + '-' + value.substring(7);
    }
    input.value = value;
}

document.getElementById('telefono_principal').addEventListener('input', function() {
    formatPhoneNumber(this);
});

document.getElementById('telefono_otro').addEventListener('input', function() {
    formatPhoneNumber(this);
});

document.getElementById('whatsapp').addEventListener('input', function() {
    formatPhoneNumber(this);
});
</script>
{% endblock %}
